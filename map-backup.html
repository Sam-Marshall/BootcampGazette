<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Jobport Mockup</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.0.js"></script>
</head>

<body>
    <div class="container">
        <div class="row text-center">
            <div class=jumbotron style="background-color: #eee; color: red; border: solid 4px black; border-radius: 12px; font-family: sans-serif;">
                <h1>What's your dream job?</h1>
                <label for="job">Job</label>
                <input type="text" name="jobtitle" id="job-input" placeholder="ex: Mechanical Engineer">
                <br>
                <label for="city">City</label>
                <input type="text" name="cityName" id="city-input" placeholder="ex: Chicago">
                <br>
                <label for="state">State</label>
                <input type="text" name="stateName" id="state-input" placeholder="ex: IL">
                <br>
                <br>
                <button class="btn btn-info" id="submit-btn">Submit</button>
            </div>
            <div class="row">
                <div id="map" style="height: 400px; width: 100%;"></div>
            </div>
            <div class="row">
                <div id="textHere"></div>
            </div>
        </div>
    </div>
    <script type="text/javascript">

        //lat lng storage
        var locationArray = [];
        //job url storage for click event to be fixed later
        var jobUrlArray = [];

        function myMap() {

            var gm = google.maps;
            var map = new gm.Map(document.getElementById('map'), {
                mapTypeId: gm.MapTypeId.SATELLITE,
                center: new gm.LatLng(37, 95),
                zoom: 6
            });

            var oms = new OverlappingMarkerSpiderfier(map);
            var iw = new gm.InfoWindow();
            oms.addListener('click', function(marker, event) {
                iw.setContent(marker.desc);
                iw.open(map, marker);
            });
            oms.addListener('spiderfy', function(markers) {
                iw.close();
            });

            for (var i = 0; i < window.locationArray.length; i++) {
                var datum = window.locationArray[i];
                var loc = new gm.LatLng(datum.lat, datum.lng);
                var marker = new gm.Marker({
                    position: loc,
                    title: datum.h,
                    map: map
                });
                marker.desc = datum.d;
                oms.addMarker(marker); // <-- here
                marker.setMap(map);
            }
          };


    $(document).ready(function() {
    

    $("#submit-btn").on("click", function(event) {
        //empty array for new search
        locationArray = [];

        $('#textHere').append("");

        event.preventDefault();

        var job = $("#job-input").val().trim();
        var jobCity = $("#city-input").val().trim();
        var jobState = $("#state-input").val().trim();

        var queryURL = "http://service.dice.com/api/rest/jobsearch/v1/simple.json?text=" + job + "&city=" + jobCity + ",+" + jobState;
        console.log(queryURL);
        $.ajax({
            url: queryURL,
            method: "GET"
        }).done(function(response) {

            console.log(response);

            var results = response.resultItemList;

            console.log(results);

            for (i = 0; i < results.length; i++) {
                //trying to capture job links. Work in progress
                jobUrlArray.push(results[i].detailUrl);

                // console.log(jobUrlArray);
                var city = results[i].location;
                // console.log(city);

                var queryURLcity = "https://maps.googleapis.com/maps/api/geocode/json?address=" + city + "&key=AIzaSyB_GC-33tMoeP_2GlBptjFH0ZIcER8Ztqg";

                $.ajax({
                    url: queryURLcity,
                    method: "GET"
                }).done(function(responsecity) {
                    // console.log(responsecity);
                    // console.log(responsecity.results[0].geometry.location);
                    locationArray.push(responsecity.results[0].geometry.location);

                }); //done function

            } //for loop

        }); //done function
        setTimeout(myMap, 3000);

    }); //submit button


    });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB_GC-33tMoeP_2GlBptjFH0ZIcER8Ztqg&callback=myMap"></script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
    <script src="http://jawj.github.io/OverlappingMarkerSpiderfier/bin/oms.min.js"></script>

</body>

</html>